name: Setup Nix Environment
description: 'Reusable workflow to setup Nix environment with flakes support using Determinate Systems'

on:
  workflow_call:
  workflow_dispatch:

jobs:
  setup-nix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          logger: pretty
          extra-conf: |
            experimental-features = nix-command flakes
            show-trace = true
      
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      
      - name: Verify Nix setup
        run: |
          echo "‚úÖ Nix installed successfully"
          nix --version
          echo "‚úÖ Flakes support enabled"
          nix flake --help > /dev/null && echo "Flakes: OK" || echo "Flakes: FAILED"
      
      - name: Check flake syntax
        run: |
          echo "üîç Checking flake syntax..."
          nix flake check --no-build
          echo "‚úÖ Flake syntax is valid"
      
      - name: Enter development shell
        run: |
          echo "üöÄ Entering development shell..."
          nix develop --command bash -c "
            echo 'Development environment ready!'
            echo 'Available tools:'
            command -v just >/dev/null && echo '  ‚úÖ just' || echo '  ‚ùå just'
            command -v alejandra >/dev/null && echo '  ‚úÖ alejandra' || echo '  ‚ùå alejandra'
            command -v nix >/dev/null && echo '  ‚úÖ nix' || echo '  ‚ùå nix'
            echo 'Running just help:'
            just help || echo 'just help failed'
          "